<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Music Room - Home</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Roboto', sans-serif; }
    body { background: url('a.jpg') no-repeat center center fixed; background-size: cover; min-height: 100vh; display: flex; justify-content: center; align-items: center; color: #fff; }
    .container { background: rgba(0, 0, 0, 0.5); padding: 40px 50px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.5); text-align: center; width: 350px; backdrop-filter: blur(8px); }
    h2 { margin-bottom: 30px; font-size: 28px; font-weight: 700; text-shadow: 1px 1px 5px rgba(0,0,0,0.7); }
    label { display: block; margin-bottom: 5px; font-weight: 500; text-align: left; }
    input { width: 100%; padding: 12px 15px; margin-bottom: 20px; border-radius: 8px; border: none; outline: none; font-size: 16px; }
    input::placeholder { color: #ccc; }
    button { width: 48%; padding: 12px 0; margin: 5px 1%; border: none; border-radius: 8px; background: #ff6b81; color: #fff; font-size: 16px; cursor: pointer; transition: 0.3s; font-weight: 500; }
    button:hover { background: #ff4757; }
    @media (max-width: 400px) { .container { width: 90%; padding: 30px 20px; } button { width: 100%; margin: 5px 0; } }
  </style>
</head>
<body>
  <div class="container">
    <h2>üé§ Music Room</h2>

    <div>
      <label for="username">Username</label>
      <input type="text" id="username" placeholder="Enter your name">
    </div>

    <div>
      <label for="room">Room Code</label>
      <input type="text" id="room" placeholder="Enter room code">
    </div>

    <div>
      <button onclick="createRoom()">Create Room</button>
      <button onclick="joinRoom()">Join Room</button>
    </div>
  </div>

  <script>
// ----------- Room Security Logic -----------
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    const token = params.get('token');
    const storedToken = localStorage.getItem('roomToken');
    const username = localStorage.getItem('username');

    // Check for required info
    if (!roomId || !token || token !== storedToken || !username) {
      alert("‚ùå Invalid or expired room link! Please go back to home and create/join a room.");
      window.location.href = "index.html";
    } else {
      console.log(`Welcome ${username} to room ${roomId}`);
    }

    // ----------- Invalidate token when user leaves -----------
    window.addEventListener('beforeunload', () => {
      // Remove token from localStorage to make link invalid
      localStorage.removeItem('roomToken');
    });

    // Optional: Prevent back navigation after leaving room
    history.pushState(null, null, location.href);
    window.onpopstate = function () {
      history.go(1);
    };
    // Map to store one-time room tokens
    const oneTimeTokens = {};

    function createRoom() {
      const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
      const token = Math.random().toString(36).substring(2, 10);
      oneTimeTokens[roomId] = token; // save token temporarily

      document.getElementById("room").value = roomId;

      alert(`Share this link only once: room.html?room=${roomId}&token=${token}`);
      joinRoom();
    }

    function joinRoom() {
      const roomId = document.getElementById("room").value.trim();
      const username = document.getElementById("username").value.trim();

      if (!roomId || !username) return alert("Please enter your username and room code!");

      const token = oneTimeTokens[roomId]; // check if token exists
      if (token) {
        localStorage.setItem("roomId", roomId);
        localStorage.setItem("username", username);
        localStorage.setItem("roomToken", token); // save for room validation
        // Remove token after first use
        delete oneTimeTokens[roomId];
        window.location.href = `room.html?room=${roomId}&token=${token}`;
      } else {
        alert("‚ùå Invalid or expired room link!");
      }
    }

    // For joining via shared link
    const params = new URLSearchParams(window.location.search);
    const roomParam = params.get('room');
    const tokenParam = params.get('token');
    if (roomParam && tokenParam) {
      const username = prompt("Enter your name to join this room:") || "Guest";
      document.getElementById('username').value = username;
      document.getElementById('room').value = roomParam;
      joinRoom();
    }
  </script>
</body>
</html>
